<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>IndexedDB</title>
</head>
<body>
    <h4>23.3.4 IndexedDB</h4>
    <h5>1.数据库</h5>
    <p>indexeDB.open()返回一个IDBRequest对象，在这个对象上可以添加onerror和onsuccess事件处理程序。</p>
    <p>调用setVersion()方法，传入以字符串形式表示的版本号，同样这个方法也会返回一个请求对象，需要再指定事件处理程序。</p>

    <h5>2.对象存储空间</h5>
    <script src="../chapter13/event.js"></script>
    <script>
        const customerData = [
            { ssn: "444-44-4444", name: "Bill", age: 35, email: "bill@company.com"},
            { ssn: "555-55-5555", name: "Donna", age: 32, email: "donna@home.org"}
        ];
        var IndexedDB = window.indexedDB ||  window.msIndexedDB || window.mozIndexedDB || window.webkitIndexedDB;
        var request, database, store;
        request = indexedDB.open("admin");
        //请求失败的回调函数句柄
        request.onerror = function(event){
            console.log("Something bad happend while trying to open: " + event.target.errorCode);
        };
        //请求成功的回调函数句柄
        request.onsuccess = function(event){
            database = event.target.result;
            if(database.version != "1.0"){
                request = database.setVersion("1.0");
                request.onerror = function(event){
                    console.log("Something bad happened while trying to set version: " + event.target.errorCode);
                };
                request.onsuccess = function(event){
                    console.log("Database initialization complete. Database name: " + database.name + ", Version: " + database.version);
                };
            }else{
                console.log("Database already initialized. Database name: " + database.name + ", Version: " + database.version);
                
            }     
            //transaction()方法接受三个参数并返回一个事务对象，第一个参数是事务希望跨越的对象存储空间列表，第二个参数表示读写状态，为空则表示只读事务
            var transaction = database.transaction(["customers"], "readwrite");
            console.log(transaction);
        }
        //请求数据库版本变化句柄,onupgradeneeded是唯一可以修改数据库结构的地方，在这里可以创建和删除对象存储空间以及构建和删除索引
        request.onupgradeneeded = function(event){
            database = event.target.result;
            //保存上述用户记录创建对象存储空间实例    
            //使用ssn作为我们的keyPath因为保证它是唯一的    
            //对象存储空间仅调用createObjectStore()创建，使用存储空间的名，和一个对象参数        
            var store = database.createObjectStore("customers", {keyPath: "ssn"});
            console.log(store);
            //创建一个索引来通过name搜索客户，可能会重复，所以不使用unique索引
            store.createIndex("name", "name", { unique: false});
            //创建一个索引来通过email搜索客户
            store.createIndex("email", "email", { unique: true});
            //在新创建的对象存储空间中保存值
            for(var i in customerData){
                store.add(customerData[i]);
            }
        }      

        //另
        function openDB(name, version){
            var version = version || 1;
            var request = window.indexedDB.open(name, version);
            request.onerror = function(e){
                console.log(e.currentTarget.error.message);
            };
            request.onsuccess = function(e){
                myDB.db = e.target.result;
            };
            //当我们传入的数据库号和数据库版本号不一致的时候调用
            request.onupgradeneeded = function(e){
                console.log("DB version changed to " + version);
            };
        }
        //关闭数据库
        function closeDB(db){
            db.close();
        }
        //删除数据库
        function deleteDB(name){
            indexedDB.deleteDatabase(name);
        }
        var myDB = {
            name: 'test',
            version: 1,
            db: null
        }
        openDB(myDB.name, myDB.version);
        setTimeout(function(){
            closeDB(myDB.db);
            deleteDB(myDB.name);
        }, 1000)
    </script>

</body>
</html>